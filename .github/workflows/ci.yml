name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # run a full matrix weekly to catch dependency drift
    - cron: '0 3 * * 1' # weekly on Monday at 03:00 UTC

jobs:
  full_tests:
    # Full install & test matrix for PRs and pushes (and scheduled runs)
    runs-on: ${{ matrix.os }}
    env:
      PYTHONPATH: ${{ github.workspace }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Ensure pip installed
        run: |
          # Ensure pip is available for this interpreter (works in most images)
          python -m ensurepip --upgrade || true
          if ! python -m pip --version >/dev/null 2>&1; then
            curl -sS https://bootstrap.pypa.io/get-pip.py | python -
          fi

      - name: Cache pip (explicit)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies (full)
        run: |
          # Upgrade packaging basics used during builds
          python -m pip install --upgrade pip setuptools wheel

          # Install project requirements and package in editable mode
          pip install -r requirements.txt
          pip install -e .

      - name: Debug Python path
        run: |
          python -c "import sys, json; print(json.dumps(sys.path, indent=2))"

      - name: Try importing package `lib`
        run: |
          python - <<'PY'
          import sys, traceback
          try:
              import lib
              print('lib imported:', getattr(lib, '__file__', '<no __file__>'))
          except Exception as e:
              print('lib import failed:', e)
              traceback.print_exc()
          print('\nPYTHONPATH:', '\n'.join(sys.path))
          PY

      - name: Run tests
        run: |
          pytest -q

  smoke_tests:
    # Lightweight smoke checks for pushes to main/master to avoid blocking quick fixes
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Ensure pip installed
        run: |
          python -m ensurepip --upgrade || true
          if ! python -m pip --version >/dev/null 2>&1; then
            curl -sS https://bootstrap.pypa.io/get-pip.py | python -
          fi

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.11-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.11-

      - name: Install minimal deps (smoke)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Quick import check (diagnostic)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import os, sys, traceback
          print('cwd:', os.getcwd())
          print('top-level files:', os.listdir('.'))
          print('sys.path:\n', '\n'.join(sys.path))
          try:
              import lib
              print('lib ok ->', getattr(lib, '__file__', '<no __file__>'))
          except Exception as e:
              print('lib import failed:', e)
              traceback.print_exc()
          PY

      - name: Run small smoke test set
        run: |
          # Run a targeted subset of tests as a smoke check. Adjust substrings as needed.
          pytest -q -k "text_utils or config_manager or csv_handler"
